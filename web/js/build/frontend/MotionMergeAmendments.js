define(["require","exports","../shared/AntragsgruenEditor"],function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MotionMergeAmendments=t.MotionMergeChangeActions=void 0;var n,a,i=4,r=6,d=17,c=8,h=9;(a=n||(n={})).ORIGINAL="orig",a.PROPOSED_PROCEDURE="prop";var l=function(){function i(){}return i.init=function(e,t,n){i.statuses=e,i.versions=t,i.votingData=n,Object.keys(e).forEach(function(e){i.statusListeners[e]=[]})},i.registerNewAmendment=function(e,t,n,a){i.statuses[e]=t,i.versions[e]=n,i.votingData[e]=a,console.log("registered new amendment status",i.statuses,i.versions,i.votingData)},i.deleteAmendment=function(e){delete i.statuses[e],delete i.versions[e],delete i.votingData[e]},i.getAmendmentStatus=function(e){return i.statuses[e]},i.getAmendmentVersion=function(e){return i.versions[e]},i.getAmendmentVotingData=function(e){return i.votingData[e]},i.registerParagraph=function(e,t){i.statusListeners[e].push(t)},i.setStatus=function(t,n){i.statuses[t]=n,i.statusListeners[t].forEach(function(e){e.onAmendmentStatusChanged(t,n)})},i.setVersion=function(t,n){i.versions[t]=n,i.statusListeners[t].forEach(function(e){e.onAmendmentVersionChanged(t,n)})},i.setVotesData=function(t,n){i.votingData[t]=n,i.statusListeners[t].forEach(function(e){e.onAmendmentVotingChanged(t,n)})},i.getAmendmentIds=function(){return Object.keys(i.statuses).map(function(e){return parseInt(e,10)})},i.getAllStatuses=function(){return i.statuses},i.getAllVersions=function(){return i.versions},i.getAllVotingData=function(){return i.votingData},i.statusListeners={},i}(),o=function(){function i(){}return i.removeEmptyParagraphs=function(){$(".texteditor").each(function(e,t){0==t.childNodes.length&&$(t).remove()})},i.accept=function(e,t){void 0===t&&(t=null);var n=$(e);n.hasClass("ice-ins")&&i.insertAccept(e,t),n.hasClass("ice-del")&&i.deleteAccept(e,t)},i.reject=function(e,t){void 0===t&&(t=null);var n=$(e);n.hasClass("ice-ins")&&i.insertReject(n,t),n.hasClass("ice-del")&&i.deleteReject(n,t)},i.insertReject=function(e,t){void 0===t&&(t=null);var n,a=e[0].nodeName.toLowerCase();n="li"==a?e.parent():e,"ul"==a||"ol"==a||"li"==a||"blockquote"==a||"pre"==a||"p"==a?(n.css("overflow","hidden").height(n.height()),n.animate({height:"0"},250,function(){n.remove(),$(".collidingParagraph:empty").remove(),i.removeEmptyParagraphs(),t&&t()})):(n.remove(),t&&t())},i.insertAccept=function(e,t){void 0===t&&(t=null);var n=$(e);n.removeClass("ice-cts ice-ins appendHint moved"),n.removeAttr("data-moving-partner data-moving-partner-id data-moving-partner-paragraph data-moving-msg"),"ul"!=e.nodeName.toLowerCase()&&"ol"!=e.nodeName.toLowerCase()||n.children().removeClass("ice-cts").removeClass("ice-ins").removeClass("appendHint"),"li"==e.nodeName.toLowerCase()&&n.parent().removeClass("ice-cts").removeClass("ice-ins").removeClass("appendHint"),"ins"==e.nodeName.toLowerCase()&&n.replaceWith(n.html()),t&&t()},i.deleteReject=function(e,t){void 0===t&&(t=null),e.removeClass("ice-cts ice-del appendHint"),e.removeAttr("data-moving-partner data-moving-partner-id data-moving-partner-paragraph data-moving-msg");var n=e[0].nodeName.toLowerCase();"ul"!=n&&"ol"!=n||e.children().removeClass("ice-cts").removeClass("ice-del").removeClass("appendHint"),"li"==n&&e.parent().removeClass("ice-cts").removeClass("ice-del").removeClass("appendHint"),"del"==n&&e.replaceWith(e.html()),t&&t()},i.deleteAccept=function(e,t){void 0===t&&(t=null);var n,a=e.nodeName.toLowerCase();n="li"==a?$(e).parent():$(e),"ul"==a||"ol"==a||"li"==a||"blockquote"==a||"pre"==a||"p"==a?(n.css("overflow","hidden").height(n.height()),n.animate({height:"0"},250,function(){n.remove(),$(".collidingParagraph:empty").remove(),i.removeEmptyParagraphs(),t&&t()})):(n.remove(),t&&t())},i}();t.MotionMergeChangeActions=o;var u=function(){function e(i,s,o,e){this.$element=i,this.parent=e;var r=null,d=null;i.popover({container:"body",animation:!1,trigger:"manual",placement:function(e){var a=$(e);return a.data("element",i),window.setTimeout(function(){var e=a.width(),t=i.offset().top,n=i.height();null===r&&0<e&&(r=s-e/2,(d=o+10)<t+19&&(d=t+19),t+n<d&&(d=t+n)),a.css("left",r+"px"),a.css("top",d+"px")},1),"bottom"},html:!0,content:this.getContent.bind(this)}),i.popover("show"),i.find("> .popover").on("mousemove",function(e){e.stopPropagation()}),window.setTimeout(this.removePopupIfInactive.bind(this),1e3)}return e.prototype.getContent=function(){var e=this.$element,t=e.data("cid");null==t&&(t=e.parent().data("cid")),e.parents(".texteditor").first().find("[data-cid="+t+"]").addClass("hover");var n=$('<div><button type="button" class="accept btn btn-sm btn-default"></button><button type="button" class="reject btn btn-sm btn-default"></button><a href="#" class="btn btn-small btn-default opener" target="_blank"><span class="glyphicon glyphicon-new-window"></span></a><div class="initiator" style="font-size: 0.8em;"></div></div>');if(n.find(".opener").attr("href",e.data("link")).attr("title",__t("merge","title_open_in_blank")),n.find(".initiator").text(__t("merge","initiated_by")+": "+e.data("username")),e.hasClass("ice-ins"))n.find("button.accept").text(__t("merge","change_accept")).on("click",this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).on("click",this.reject.bind(this));else if(e.hasClass("ice-del"))n.find("button.accept").text(__t("merge","change_accept")).on("click",this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).on("click",this.reject.bind(this));else if("li"==e[0].nodeName.toLowerCase()){var a=e.parent();a.hasClass("ice-ins")?(n.find("button.accept").text(__t("merge","change_accept")).on("click",this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).on("click",this.reject.bind(this))):a.hasClass("ice-del")?(n.find("button.accept").text(__t("merge","change_accept")).on("click",this.accept.bind(this)),n.find("button.reject").text(__t("merge","change_reject")).on("click",this.reject.bind(this))):console.log("unknown",a)}else console.log("unknown",e),alert("unknown");return n},e.prototype.removePopupIfInactive=function(){return this.$element.is(":hover")?window.setTimeout(this.removePopupIfInactive.bind(this),1e3):0<$("body").find(".popover:hover").length?window.setTimeout(this.removePopupIfInactive.bind(this),1e3):void this.destroy()},e.prototype.affectedChangesets=function(){var e=this.$element.data("cid");return null==e&&(e=this.$element.parent().data("cid")),this.$element.parents(".texteditor").find("[data-cid="+e+"]")},e.prototype.performActionWithUI=function(e){var t=window.scrollX,n=window.scrollY;this.parent.saveEditorSnapshot(),this.destroy(),e.call(this),this.parent.focusTextarea(),window.scrollTo(t,n)},e.prototype.accept=function(){var n=this;this.performActionWithUI(function(){n.affectedChangesets().each(function(e,t){o.accept(t,function(){n.parent.onChanged()})})})},e.prototype.reject=function(){var n=this;this.performActionWithUI(function(){n.affectedChangesets().each(function(e,t){o.reject(t,function(){n.parent.onChanged()})})})},e.prototype.destroy=function(){this.$element.popover("hide").popover("destroy");var e=this.$element.data("cid");null==e&&(e=this.$element.parent().data("cid"));var n=!1;this.$element.parents(".texteditor").first().find("[data-cid="+e+"]").each(function(e,t){$(t).is(":hover")&&(n=!0)}),n||this.$element.parents(".texteditor").first().find("[data-cid="+e+"]").removeClass("hover");try{$(".popover").each(function(e,t){var n=$(t);n.data("element").is(":hover")||(n.popover("hide").popover("destroy"),n.remove(),console.warn("Removed stale window: ",n))})}catch(e){}},e}(),m=function(){function e(e,t,n){this.$holder=e,this.$changedIndicator=t,this.$mergeActionHolder=n,this.unchangedText=null,this.hasChanged=!1,this.changedListeners=[];var a=e.find(".texteditor"),i=new s.AntragsgruenEditor(a.attr("id"));this.texteditor=i.getEditor(),this.setText(this.texteditor.getData()),e.data("unchanged")&&(this.unchangedText=e.data("unchanged"),this.onChanged()),this.texteditor.on("change",this.onChanged.bind(this))}return e.prototype.prepareText=function(e){var t=$("<div>"+e+"</div>");t.find("ul.appendHint, ol.appendHint").each(function(e,t){var n=$(t),a=n.data("append-hint");n.find("> li").addClass("appendHint").attr("data-append-hint",a).attr("data-link",n.data("link")).attr("data-username",n.data("username")),n.removeClass("appendHint").removeData("append-hint")}),t.find(".moved .moved").removeClass("moved"),t.find(".moved").each(this.markupMovedParagraph.bind(this));var n=t.html();this.texteditor.setData(n),this.unchangedText=this.normalizeHtml(this.texteditor.getData()),this.texteditor.fire("saveSnapshot"),this.onChanged()},e.prototype.addChangedListener=function(e){this.changedListeners.push(e)},e.prototype.markupMovedParagraph=function(e,t){var n,a=$(t),i=a.data("moving-partner-paragraph");n=(n=a.hasClass("inserted")?__t("std","moved_paragraph_from"):__t("std","moved_paragraph_to")).replace(/##PARA##/,i+1),"LI"===a[0].nodeName&&(a=a.parent()),a.attr("data-moving-msg",n)},e.prototype.initializeTooltips=function(){var n=this;this.$holder.on("mouseover",".appendHint",function(e){var t=$(e.currentTarget);0<t.parents(".paragraphWrapper").first().find(".amendmentStatus.open").length||(g.activePopup&&g.activePopup.destroy(),g.activePopup=new u(t,e.pageX,e.pageY,n))})},e.prototype.acceptAll=function(){var e=this;this.saveEditorSnapshot(),this.$holder.find(".ice-ins").each(function(e,t){o.insertAccept(t)}),this.$holder.find(".ice-del").each(function(e,t){o.deleteAccept(t)}),this.onChanged(),window.setTimeout(function(){e.onChanged(),e.saveEditorSnapshot()},1e3)},e.prototype.rejectAll=function(){var e=this;this.saveEditorSnapshot(),this.$holder.find(".ice-ins").each(function(e,t){o.insertReject($(t))}),this.$holder.find(".ice-del").each(function(e,t){o.deleteReject($(t))}),this.onChanged(),window.setTimeout(function(){e.onChanged(),e.saveEditorSnapshot()},1e3)},e.prototype.saveEditorSnapshot=function(){this.texteditor.fire("saveSnapshot")},e.prototype.focusTextarea=function(){},e.prototype.getContent=function(){return this.texteditor.getData()},e.prototype.getUnchangedContent=function(){return this.unchangedText},e.prototype.setText=function(e){this.prepareText(e),this.initializeTooltips()},e.prototype.normalizeHtml=function(t){var n={"&nbsp;":" ","&ndash;":"-","&auml;":"ä","&ouml;":"ö","&uuml;":"ü","&Auml;":"Ä","&Ouml;":"Ö","&Uuml;":"Ü","&szlig;":"ß","&bdquo;":"„","&ldquo;":"“","&bull;":"•","&sect;":"§","&eacute;":"é","&rsquo;":"’","&euro;":"€"};return Object.keys(n).forEach(function(e){t=t.replace(new RegExp(e,"g"),n[e])}),t.replace(/\s+</g,"<").replace(/>\s+/g,">").replace(/<[^>]*ice-ins[^>]*>/g,"ice-ins").replace(/<ins[^>]*>/g,"ice-ins").replace(/<[^>]*>/g,"")},e.prototype.onChanged=function(){this.normalizeHtml(this.texteditor.getData())===this.unchangedText?(this.$changedIndicator.addClass("unchanged"),this.hasChanged=!1):(this.$changedIndicator.removeClass("unchanged"),this.hasChanged=!0),0<this.$holder.find(".ice-ins").length||0<this.$holder.find(".ice-del").length?this.$mergeActionHolder.removeClass("hidden"):this.$mergeActionHolder.addClass("hidden"),this.changedListeners.forEach(function(e){return e()})},e.prototype.hasChanges=function(){return this.hasChanged},e}(),p=function(){function e(e,t,n){var a=this;this.$holder=e,this.hasUnsavedChanges=!1,this.handledCollisions=[],this.sectionId=parseInt(e.data("sectionId")),this.paragraphId=parseInt(e.data("paragraphId"));var i=t.paragraphs&&t.paragraphs[this.sectionId+"_"+this.paragraphId]?t.paragraphs[this.sectionId+"_"+this.paragraphId]:null;i.handledCollisions&&(this.handledCollisions=i.handledCollisions);var s=e.find(".wysiwyg-textarea"),o=e.find(".changedIndicator"),r=e.find(".mergeActionHolder");this.textarea=new m(s,o,r),this.initButtons(),this.initSetCollisionsAsHandled(),this.initStatusWidget(n),e.find(".amendmentStatus").each(function(e,t){l.registerParagraph($(t).data("amendment-id"),a)}),this.textarea.addChangedListener(function(){return a.hasUnsavedChanges=!0})}return e.prototype.initStatusWidget=function(n){for(var a=this.$holder.find(".changeToolbar .statuses").data("amendments"),e=function(e){var t=a[e].amendmentId;a[e].amendment=n.find(function(e){return e.id===t}),a[e].status=l.getAmendmentStatus(t),a[e].version=l.getAmendmentVersion(t),a[e].votingData=JSON.parse(JSON.stringify(l.getAmendmentVotingData(t)))},t=0;t<a.length;t++)e(t);var s=this,o=function(t){s.textarea.hasChanges()?bootbox.confirm(__t("merge","reloadParagraph"),function(e){e&&t()}):t()};s.statusWidget=new Vue({el:this.$holder.find(".changeToolbar .statuses")[0],template:'\n                <div class="statuses">\n                    <paragraph-amendment-settings v-for="data in amendmentParagraphData"\n                                                  v-bind:amendment="data.amendment"\n                                                  v-bind:nameBase="data.nameBase"\n                                                  v-bind:idAdd="data.idAdd"\n                                                  v-bind:active="data.active"\n                                                  v-bind:status="data.status"\n                                                  v-bind:version="data.version"\n                                                  v-bind:votingData="data.votingData"\n                                                  v-on:update="update($event)"\n                    ></paragraph-amendment-settings>\n                </div>',data:{amendmentParagraphData:a},created:function(){this.$on("status-updated",function(e){var t=e[1],n=this.getAmendmentData(e[0]);n&&(n.status=t,s.textarea.hasChanges()||(n.active=-1!==[i,r,d,c,h].indexOf(t),s.reloadText()))}),this.$on("voting-updated",function(e){var t=this.getAmendmentData(e[0]);t&&(t.votingData=e[1])}),this.$on("version-updated",function(e){var t=this.getAmendmentData(e[0]);t&&(t.version=e[1],s.textarea.hasChanges()||s.reloadText())}),this.$on("amendment-added",function(e){var t=e[0],n=e[1],a=e[2],i=e[3],s=e[4],o=e[5],r=e[6];this.amendmentParagraphData.push({amendmentId:t.id,amendment:t,nameBase:n,idAdd:a,active:i,status:s,verstion:o,votingData:r})}),this.$on("amendment-deleted",function(e){var t=e[0];this.amendmentParagraphData=this.amendmentParagraphData.filter(function(e){return e.amendmentId!=t})})},methods:{getAllAmendmentData:function(){return this.amendmentParagraphData},getAmendmentData:function(e){for(var t=0;t<this.amendmentParagraphData.length;t++)if(this.amendmentParagraphData[t].amendmentId==e)return this.amendmentParagraphData[t];return null},setAmendmentActive:function(e,t){e.active=t,s.reloadText()},update:function(e){var t=this,n=e[0],a=e[1],i=this.getAmendmentData(a);if(i){switch(n){case"set-active":o(function(){return t.setAmendmentActive(i,e[2])});break;case"set-status":l.setStatus(a,parseInt(e[2]));break;case"set-votes":l.setVotesData(a,e[2]);break;case"set-version":o(function(){l.setVersion(a,e[2]),s.reloadText()})}s.hasUnsavedChanges=!0}}}})},e.prototype.onAmendmentVersionChanged=function(e,t){this.statusWidget.$emit("version-updated",[e,t])},e.prototype.onAmendmentVotingChanged=function(e,t){this.statusWidget.$emit("voting-updated",[e,t])},e.prototype.onAmendmentStatusChanged=function(e,t){this.statusWidget.$emit("status-updated",[e,t])},e.prototype.onAmendmentAdded=function(e,t,n,a,i,s,o){this.statusWidget.$emit("amendment-added",[e,t,n,a,i,s,o])},e.prototype.onAmendmentDeleted=function(e){this.statusWidget.$emit("amendment-deleted",[e])},e.prototype.initSetCollisionsAsHandled=function(){var i=this;this.$holder.on("click","button.hideCollision",function(e){var t=$(e.currentTarget).parents(".collidingParagraph").first(),n=parseInt(t.data("amendment-id"),10),a=t.parent();t.remove(),0===a.children().length&&i.$holder.removeClass("hasCollisions"),i.handledCollisions.push(n),i.hasUnsavedChanges=!0})},e.prototype.initButtons=function(){var t=this;this.$holder.find(".mergeActionHolder .acceptAll").on("click",function(e){e.preventDefault(),t.textarea.acceptAll(),t.hasUnsavedChanges=!0}),this.$holder.find(".mergeActionHolder .rejectAll").on("click",function(e){e.preventDefault(),t.textarea.rejectAll(),t.hasUnsavedChanges=!0})},e.prototype.reloadText=function(){var n=this,e=this.statusWidget.getAllAmendmentData().filter(function(e){return e.active}).map(function(e){return{id:e.amendmentId,version:l.getAmendmentVersion(e.amendmentId)}}),t=this.$holder.data("reload-url").replace("DUMMY",JSON.stringify(e));$.get(t,function(e){n.textarea.setText(e.text);var t="";e.collisions.forEach(function(e){t+=e}),n.$holder.find(".collisionsHolder").html(t),0<e.collisions.length?n.$holder.addClass("hasCollisions"):n.$holder.removeClass("hasCollisions"),n.handledCollisions=[],n.hasUnsavedChanges=!0})},e.prototype.getDraftData=function(){return{amendmentToggles:this.statusWidget.getAllAmendmentData().filter(function(e){return e.active}).map(function(e){return e.amendmentId}),text:this.textarea.getContent(),unchanged:this.textarea.getUnchangedContent(),handledCollisions:this.handledCollisions}},e.prototype.onDraftChanged=function(){this.hasUnsavedChanges=!1},e}(),g=function(){function d(e){var s=this;this.paragraphsByTypeAndNo={},this.hasUnsavedChanges=!1,d.$form=e;var o=JSON.parse(document.getElementById("mergeDraft").getAttribute("value"));l.init(o.amendmentStatuses,o.amendmentVersions,o.amendmentVotingData);var r=e.data("amendment-static-data");$(".paragraphWrapper").each(function(e,t){var n=$(t),a=n.data("section-id"),i=n.data("paragraph-id");n.find(".wysiwyg-textarea").on("mousemove",function(e){d.currMouseX=e.offsetX}),s.paragraphsByTypeAndNo[a+"_"+i]=new p(n,o,r)}),d.$form.on("submit",function(){s.hasUnsavedChanges=!0,s.saveDraft(!0),$(window).off("beforeunload",d.onLeavePage)}),$(window).on("beforeunload",d.onLeavePage),this.initDraftSaving(),this.initNewAmendmentAlert(),this.initCheckBackendStatus(),this.initRemovingSectionTexts()}return d.onLeavePage=function(){return __t("std","leave_changed_page")},d.prototype.setDraftDate=function(e){this.$draftSavingPanel.find(".lastSaved .none").hide();var t=$("html").attr("lang"),n=new Intl.DateTimeFormat(t,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",hour12:!1}).format(e);this.$draftSavingPanel.find(".lastSaved .value").text(n)},d.prototype.initRemovingSectionTexts=function(){d.$form.find(".removeSection input[type=checkbox]").on("change",function(e){var t=$(e.currentTarget),n=t.parents(".section").first();t.prop("checked")?n.find(".sectionHolder").addClass("hidden"):n.find(".sectionHolder").removeClass("hidden")}).trigger("change")},d.prototype.saveDraft=function(e){var t=this;if(void 0===e&&(e=!1),0!==Object.keys(this.paragraphsByTypeAndNo).map(function(e){return t.paragraphsByTypeAndNo[e]}).filter(function(e){return e.hasUnsavedChanges}).length||this.hasUnsavedChanges){console.log("Has unsaved changes");var i={amendmentStatuses:l.getAllStatuses(),amendmentVersions:l.getAllVersions(),amendmentVotingData:l.getAllVotingData(),paragraphs:{},sections:{},removedSections:[]};$(".sectionType0").each(function(e,t){var n=$(t),a=n.data("section-id");i.sections[a]=n.find(".form-control").val()}),d.$form.find(".removeSection input[type=checkbox]:checked").each(function(e,t){i.removedSections.push(parseInt($(t).val()))}),Object.keys(this.paragraphsByTypeAndNo).forEach(function(e){i.paragraphs[e]=t.paragraphsByTypeAndNo[e].getDraftData()});var n=this.$draftSavingPanel.find("input[name=public]").prop("checked"),a=JSON.stringify(i);document.getElementById("mergeDraft").setAttribute("value",a),e||$.ajax({type:"POST",url:d.$form.data("draftSavingUrl"),data:{public:n?1:0,data:a,_csrf:d.$form.find("> input[name=_csrf]").val()},success:function(e){e.success?(t.$draftSavingPanel.find(".savingError").addClass("hidden"),t.setDraftDate(new Date(e.date)),n?d.$form.find(".publicLink").removeClass("hidden"):d.$form.find(".publicLink").addClass("hidden")):(t.$draftSavingPanel.find(".savingError").removeClass("hidden"),t.$draftSavingPanel.find(".savingError .errorNetwork").addClass("hidden"),t.$draftSavingPanel.find(".savingError .errorHolder").text(e.error).removeClass("hidden")),Object.keys(t.paragraphsByTypeAndNo).forEach(function(e){return t.paragraphsByTypeAndNo[e].onDraftChanged()}),t.hasUnsavedChanges=!1},error:function(){t.$draftSavingPanel.find(".savingError").removeClass("hidden"),t.$draftSavingPanel.find(".savingError .errorNetwork").removeClass("hidden"),t.$draftSavingPanel.find(".savingError .errorHolder").text("").addClass("hidden")}})}},d.prototype.initAutosavingDraft=function(){var e=this,t=this.$draftSavingPanel.find("input[name=autosave]");if(window.setInterval(function(){t.prop("checked")&&e.saveDraft(!1)},5e3),localStorage){var n=localStorage.getItem("merging-draft-auto-save");null!==n&&t.prop("checked","1"==n)}t.on("change",function(){var e=t.prop("checked");localStorage&&localStorage.setItem("merging-draft-auto-save",e?"1":"0")}).trigger("change")},d.prototype.initDraftSaving=function(){var e=this;if(this.$draftSavingPanel=d.$form.find("#draftSavingPanel"),this.$draftSavingPanel.find(".saveDraft").on("click",function(){e.hasUnsavedChanges=!0,e.saveDraft(!1)}),this.$draftSavingPanel.find("input[name=public]").on("change",function(){e.hasUnsavedChanges=!0,e.saveDraft(!1)}),this.initAutosavingDraft(),this.$draftSavingPanel.data("resumed-date")){var t=new Date(this.$draftSavingPanel.data("resumed-date"));this.setDraftDate(t)}$(".sectionType0").on("change",function(){return e.hasUnsavedChanges=!0}),$("#yii-debug-toolbar").remove()},d.prototype.initNewAmendmentAlert=function(){var e=this;this.$newAmendmentAlert=d.$form.find("#newAmendmentAlert"),this.$newAmendmentAlert.find(".closeLink").on("click",function(){e.$newAmendmentAlert.find(".buttons").children().remove(),e.$newAmendmentAlert.removeClass("revealed"),window.setTimeout(function(){e.$newAmendmentAlert.addClass("hidden")},1e3)})},d.prototype.alertAboutNewAmendment=function(e,t){var n=this,a=this.$newAmendmentAlert.find(".buttons"),i=$('<button class="btn-link gotoAmendment" type="button"></button>').text(t);i.on("click",function(){$(".amendmentStatus"+e).first().parents(".paragraphWrapper").scrollintoview({top_offset:-100})}),a.append(i),1<a.children().length?(this.$newAmendmentAlert.find(".message .one").addClass("hidden"),this.$newAmendmentAlert.find(".message .many").removeClass("hidden")):(this.$newAmendmentAlert.find(".message .one").removeClass("hidden"),this.$newAmendmentAlert.find(".message .many").addClass("hidden")),this.$newAmendmentAlert.hasClass("hidden")&&(this.$newAmendmentAlert.removeClass("hidden"),window.setTimeout(function(){n.$newAmendmentAlert.addClass("revealed")},100))},d.prototype.initCheckBackendStatus=function(){var n=this;window.setInterval(function(){var e=d.$form.data("checkStatusUrl"),t=l.getAmendmentIds();e=e.replace(/AMENDMENTS/,t.join(",")),$.get(e,function(e){e.success?n.onReceivedBackendStatus(e.new,e.deleted):console.warn(e)})},3e3)},d.prototype.onReceivedBackendStatus=function(i,e){var s=this,o={};i.staticData.forEach(function(e){o[e.id]=e;var a=i.status[e.id];l.registerNewAmendment(e.id,a.status,a.version,a.votingData),Object.keys(i.paragraphs).forEach(function(t){Object.keys(i.paragraphs[t]).forEach(function(e){var n=s.paragraphsByTypeAndNo[t+"_"+e];i.paragraphs[t][e].forEach(function(e){var t=o[e.amendmentId];n.onAmendmentAdded(t,e.nameBase,e.idAdd,e.active,a.status,a.version,a.votingData)})})}),s.alertAboutNewAmendment(e.id,e.titlePrefix)}),e.forEach(function(t){console.log("Removing amendment",t),l.deleteAmendment(t),Object.keys(s.paragraphsByTypeAndNo).forEach(function(e){s.paragraphsByTypeAndNo[e].onAmendmentDeleted(t)})})},d.activePopup=null,d.currMouseX=null,d}();t.MotionMergeAmendments=g});
//# sourceMappingURL=MotionMergeAmendments.js.map
