{"version":3,"sources":["frontend/AmendmentEdit.ts"],"names":["AmendmentEdit","$form","this","hasChanged","multiParagraphMode","data","lang","$","attr","find","on","editorialOpenerClicked","bind","trigger","initGlobalAlternative","datetimepicker","locale","format","initMultiParagraphMode","spmInit","$draftHint","draftMotionId","draftAmendmentId","DraftSavingEngine_1","DraftSavingEngine","window","off","onLeavePage","prototype","_this","$holder","$textarea","prop","removeClass","undefined","CKEDITOR","instances","editor_1","AntragsgruenEditor_1","AntragsgruenEditor","parents","parent","val","getEditor","getData","onContentChanged","addClass","each","i","el","ckeditor","plugins","lite","findPlugin","acceptAll","ev","$text","currentTarget","setData","spmSetModifyable","$modified","$spmParagraphs","filter","length","spmOnParaClick","$para","hasClass","editor","spmRevert","preventDefault","stopPropagation","target","destroyInstanceById","html","spmInitNonSingleParas","$this","sectionId","paraNo","__t","exports"],"mappings":"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","file":"AmendmentEdit.js","sourcesContent":["import {AntragsgruenEditor} from \"../shared/AntragsgruenEditor\";\nimport {DraftSavingEngine} from \"../shared/DraftSavingEngine\";\n\nexport class AmendmentEdit {\n    private lang: string;\n    private $spmParagraphs: JQuery;\n    private hasChanged: boolean = false;\n\n    constructor(private $form: JQuery) {\n        let multiParagraphMode = $form.data(\"multi-paragraph-mode\");\n        if (typeof(multiParagraphMode) == \"undefined\") {\n            throw \"data-multi-paragraph-mode needs to be set\";\n        }\n\n        this.lang = $(\"html\").attr('lang');\n\n        this.$form.find(\".editorialChange input\").on(\"change\", this.editorialOpenerClicked.bind(this)).trigger(\"change\");\n        this.initGlobalAlternative();\n\n        $(\".input-group.date\").datetimepicker({\n            locale: this.lang,\n            format: 'L'\n        });\n\n        if (multiParagraphMode) {\n            this.initMultiParagraphMode();\n        } else {\n            this.spmInit();\n        }\n\n        let $draftHint = $(\"#draftHint\"),\n            draftMotionId = $draftHint.data(\"motion-id\"),\n            draftAmendmentId = $draftHint.data(\"amendment-id\");\n\n        new DraftSavingEngine($form, $draftHint, \"motion_\" + draftMotionId + \"_\" + draftAmendmentId);\n\n        $form.on(\"submit\", () => {\n            $(window).off(\"beforeunload\", AmendmentEdit.onLeavePage);\n        });\n    }\n\n    private initGlobalAlternative() {\n\n    }\n\n    private editorialOpenerClicked() {\n        let $holder = this.$form.find(\"#sectionHolderEditorial\"),\n            $textarea = $holder.find(\".texteditor\"),\n            active = this.$form.find(\".editorialChange input\").prop(\"checked\");\n\n        if (active) {\n            $holder.removeClass(\"hidden\");\n            if (CKEDITOR.instances['amendmentEditorial_wysiwyg'] === undefined) {\n                let editor: AntragsgruenEditor = new AntragsgruenEditor(\"amendmentEditorial_wysiwyg\");\n                $textarea.parents(\"form\").on(\"submit\", () => {\n                    if (this.$form.find(\".editorialChange input\").prop(\"checked\")) {\n                        $textarea.parent().find(\"textarea.raw\").val(editor.getEditor().getData());\n                    } else {\n                        $textarea.parent().find(\"textarea.raw\").val(\"\");\n                    }\n                });\n                $(\"#\" + $textarea.attr(\"id\")).on('keypress', this.onContentChanged.bind(this));\n            }\n        } else {\n            $holder.addClass(\"hidden\");\n        }\n    }\n\n    /* Multi paragraph mode */\n\n    private initMultiParagraphMode() {\n        $(\".wysiwyg-textarea:not(#sectionHolderEditorial)\").each((i, el) => {\n            let $holder = $(el),\n                $textarea = $holder.find(\".texteditor\");\n\n            let editor: AntragsgruenEditor = new AntragsgruenEditor($textarea.attr(\"id\")),\n                ckeditor: CKEDITOR.editor = editor.getEditor();\n\n            $textarea.parents(\"form\").on(\"submit\", () => {\n                $textarea.parent().find(\"textarea.raw\").val(ckeditor.getData());\n                if (typeof(ckeditor.plugins.lite) != 'undefined') {\n                    ckeditor.plugins.lite.findPlugin(ckeditor).acceptAll();\n                    $textarea.parent().find(\"textarea.consolidated\").val(ckeditor.getData());\n                }\n            });\n\n            // The editor doesn't trigger change-events when tracking changes is enabled, therefore this work-around\n            $('#' + $textarea.attr('id')).on('keypress', this.onContentChanged.bind(this));\n        });\n\n        this.$form.find('.resetText').on(\"click\", (ev) => {\n            let $text: JQuery = $(ev.currentTarget).parents('.wysiwyg-textarea').find('.texteditor');\n            window['CKEDITOR']['instances'][$text.attr('id')].setData($text.data('original-html'));\n\n            $(ev.currentTarget).parents('.modifiedActions').addClass('hidden');\n        });\n    }\n\n    /* Single paragraph mode */\n\n    private spmSetModifyable() {\n        let $modified = this.$spmParagraphs.filter(\".modified\");\n        if ($modified.length == 0) {\n            this.$spmParagraphs.addClass('modifyable');\n        } else {\n            this.$spmParagraphs.removeClass('modifyable');\n            $('input[name=modifiedParagraphNo]').val($modified.data(\"paragraph-no\"));\n            $('input[name=modifiedSectionId]').val($modified.parents(\".texteditorBox\").data(\"section-id\"));\n        }\n    }\n\n    private spmOnParaClick(ev) {\n        let $para = $(ev.currentTarget);\n        if (!$para.hasClass('modifyable')) {\n            return;\n        }\n        $para.addClass('modified');\n        this.spmSetModifyable();\n\n        let $textarea = $para.find(\".texteditor\"),\n            editor;\n        if (typeof(CKEDITOR.instances[$textarea.attr(\"id\")]) !== \"undefined\") {\n            editor = CKEDITOR.instances[$textarea.attr(\"id\")];\n        } else {\n            editor = (new AntragsgruenEditor($textarea.attr(\"id\"))).getEditor();\n        }\n        $textarea.attr(\"contenteditable\", \"true\");\n        $textarea.parents(\"form\").on(\"submit\", () => {\n            $textarea.parent().find(\"textarea.raw\").val(editor.getData());\n            if (typeof(editor.plugins.lite) != 'undefined') {\n                editor.plugins.lite.findPlugin(editor).acceptAll();\n                $textarea.parent().find(\"textarea.consolidated\").val(editor.getData());\n            }\n        });\n\n        // The editor doesn't trigger change-events when tracking changes is enabled, therefore this work-around\n        $(\"#\" + $textarea.attr(\"id\")).on('keypress', this.onContentChanged.bind(this));\n\n        $textarea.trigger(\"focus\");\n    }\n\n    private spmRevert(ev) {\n        ev.preventDefault();\n        ev.stopPropagation();\n        let $para = $(ev.target).parents(\".wysiwyg-textarea\"),\n            $textarea = $para.find(\".texteditor\"),\n            id = $textarea.attr(\"id\");\n\n        if (typeof(CKEDITOR.instances[$textarea.attr(\"id\")]) !== \"undefined\") {\n            AntragsgruenEditor.destroyInstanceById($textarea.attr(\"id\"));\n        }\n\n        $textarea.html($para.data(\"original\"));\n        $para.removeClass(\"modified\");\n        this.spmSetModifyable();\n    }\n\n    private spmInitNonSingleParas(i, el) {\n        let $holder = $(el),\n            $textarea = $holder.find(\".texteditor\");\n        if ($holder.hasClass(\"hidden\")) {\n            return;\n        }\n        let editor: CKEDITOR.editor = (new AntragsgruenEditor($textarea.attr(\"id\"))).getEditor();\n        $textarea.parents(\"form\").on(\"submit\", () => {\n            $textarea.parent().find(\"textarea.raw\").val(editor.getData());\n            if (typeof(editor.plugins.lite) != 'undefined') {\n                editor.plugins.lite.findPlugin(editor).acceptAll();\n                $textarea.parent().find(\"textarea.consolidated\").val(editor.getData());\n            }\n        });\n\n        // The editor doesn't trigger change-events when tracking changes is enabled, therefore this work-around\n        $(\"#\" + $textarea.attr(\"id\")).on('keypress', this.onContentChanged.bind(this));\n    }\n\n    private spmInit() {\n        this.$spmParagraphs = $(\".wysiwyg-textarea.single-paragraph\");\n        this.$spmParagraphs.on(\"click\", this.spmOnParaClick.bind(this));\n        this.$spmParagraphs.find(\".modifiedActions .revert\").on(\"click\", this.spmRevert.bind(this));\n        this.spmSetModifyable();\n\n        // Amendment Reason\n        $(\".wysiwyg-textarea\").filter(\":not(.single-paragraph)\").each(this.spmInitNonSingleParas.bind(this));\n\n        $(\".texteditorBox\").each((i, el) => {\n            let $this = $(el),\n                sectionId = $this.data(\"section-id\"),\n                paraNo = $this.data(\"changed-para-no\");\n            if (paraNo > -1) {\n                $(\"#section_holder_\" + sectionId + \"_\" + paraNo).trigger(\"click\");\n            }\n        });\n    }\n\n    public static onLeavePage(): string {\n        return __t(\"std\", \"leave_changed_page\");\n    }\n\n    public onContentChanged() {\n        if (!this.hasChanged) {\n            this.hasChanged = true;\n            if (!$(\"body\").hasClass('testing')) {\n                $(window).on(\"beforeunload\", AmendmentEdit.onLeavePage);\n            }\n        }\n    }\n}\n"]}