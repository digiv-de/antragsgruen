var __awaiter=this&&this.__awaiter||function(e,o,s,d){return new(s||(s=Promise))(function(t,n){function i(e){try{a(d.next(e))}catch(e){n(e)}}function l(e){try{a(d.throw(e))}catch(e){n(e)}}function a(e){e.done?t(e.value):function(t){return t instanceof s?t:new s(function(e){e(t)})}(e.value).then(i,l)}a((d=d.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(n,i){var l,a,o,e,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(l)throw new TypeError("Generator is already executing.");for(;s;)try{if(l=1,a&&(o=2&t[0]?a.return:t[0]?a.throw||((o=a.return)&&o.call(a),0):a.next)&&!(o=o.call(a,t[1])).done)return o;switch(a=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,a=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(o=0<(o=s.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){s.label=t[1];break}if(6===t[0]&&s.label<o[1]){s.label=o[1],o=t;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(t);break}o[2]&&s.ops.pop(),s.trys.pop();continue}t=i.call(n,s)}catch(e){t=[6,e],a=0}finally{l=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};define(["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ContentPageEdit=void 0;var n=function(){function e(e){(this.$form=e).on("submit",function(e){return e.preventDefault()}),this.$textSaver=e.find(".textSaver"),this.$textHolder=e.find(".textHolder"),this.$editCaller=e.find(".editCaller"),this.$contentSettings=e.find(".contentSettingsToolbar"),this.$downloadableFiles=e.find(".downloadableFiles"),this.$editCaller.on("click",this.editCalled.bind(this)),this.$textSaver.addClass("hidden"),this.$textSaver.find("button").on("click",this.save.bind(this)),0<this.$contentSettings.length&&this.initContentSettings(),0<this.$downloadableFiles.length&&this.initDownloadableFiles(),$(".deletePageForm").on("submit",this.onSubmitDeleteForm.bind(this))}return e.prototype.editCalled=function(e){var t=this;e.preventDefault(),this.$editCaller.addClass("hidden"),this.$textHolder.attr("contenteditable","true"),this.editor=CKEDITOR.inline(this.$textHolder.attr("id"),{scayt_sLang:"de_DE",removePlugins:"lite,showbloks,about,selectall,forms",extraPlugins:"uploadimage",uploadUrl:this.$form.data("upload-url"),filebrowserBrowseUrl:this.$form.data("image-browse-url"),toolbarGroups:[{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"colors"},{name:"links"},{name:"insert"},{name:"others"},{name:"tools"},"/",{name:"styles"},{name:"paragraph",groups:["list","indent","blocks","align","bidi"]}]}),this.editor.on("fileUploadRequest",function(e){e.data.requestData._csrf=t.$form.find("> input[name=_csrf]").val()}),this.$textHolder.trigger("focus"),this.$textSaver.removeClass("hidden"),this.$contentSettings.removeClass("hidden"),this.showDownloadableFiles()},e.prototype.initContentSettings=function(){this.$contentSettings.find("input[name=url]").on("keyup change keypress",function(e){var t=$(e.currentTarget);t.val(t.val().replace(/[^\w_\-,\.äöüß]/,""))})},e.prototype.initDownloadableFiles=function(){var i=this,n=this.$downloadableFiles.find(".uploadCol .text");this.$downloadableFiles.find("input[type=file]").on("change",function(){var e=i.$downloadableFiles.find("input[type=file]").val().split("\\"),t=e[e.length-1];n.text(t)}),this.$downloadableFiles.find(".fileList").on("click",".deleteFile",function(e){var t=$(e.currentTarget).parents("li").first().data("id"),n=i.$form.data("del-confirmation");bootbox.confirm(n,function(e){e&&i.deleteDownloadableFile(t)})})},e.prototype.deleteDownloadableFile=function(t){var n=this,e=this.$form.data("file-delete-url"),i={id:t,_csrf:this.$form.find("> input[name=_csrf]").val()};$.post(e,i,function(e){e.success?(n.$downloadableFiles.find(".fileList li[data-id="+t+"]").remove(),0===n.$downloadableFiles.find(".fileList").children().length&&n.$downloadableFiles.find(".none").removeClass("hidden")):alert(e.message)})},e.prototype.addUploadedFileCb=function(e){var t=$('<li><a><span class="glyphicon glyphicon-download-alt"></span> <span class="title"></span></a><button type="button" class="btn btn-link deleteFile"><span class="glyphicon glyphicon-trash"></span></button></li>');t.find("a").attr("href",e.url),t.find("a .title").text(e.title),t.attr("data-id",e.id),this.$downloadableFiles.find("ul").append(t),this.$downloadableFiles.find(".none").addClass("hidden")},e.prototype.hideDownloadableFiles=function(){0<this.$downloadableFiles.find("ul li").length||this.$downloadableFiles.addClass("hidden"),this.$downloadableFiles.find(".downloadableFilesUpload").addClass("hidden"),this.$downloadableFiles.find("#downloadableFileNew").val(""),this.$downloadableFiles.find("#downloadableFileTitle").val(""),this.$downloadableFiles.find(".uploadCol .text").text(this.$downloadableFiles.find(".uploadCol .text").data("title"))},e.prototype.showDownloadableFiles=function(){this.$downloadableFiles.removeClass("hidden"),this.$downloadableFiles.find(".downloadableFilesUpload").removeClass("hidden")},e.prototype.readUploadableFile=function(i){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,new Promise(function(t,e){var n=new FileReader;n.onload=function(){var e=n.result.split(";base64,");2===e.length?t(e[1]):(alert("Could not read the given file"),t(null))},0<i.files.length?n.readAsDataURL(i.files[0]):t(null)})]})})},e.prototype.save=function(s){return __awaiter(this,void 0,void 0,function(){var t,n,i,l,a,o=this;return __generator(this,function(e){switch(e.label){case 0:return s.preventDefault(),t={data:this.editor.getData(),_csrf:this.$form.find("> input[name=_csrf]").val()},0<this.$contentSettings.length&&(t.url=this.$contentSettings.find("input[name=url]").val(),t.title=this.$contentSettings.find("input[name=title]").val(),t.allConsultations=this.$contentSettings.find("input[name=allConsultations]").prop("checked")?1:0,t.inMenu=this.$contentSettings.find("input[name=inMenu]").prop("checked")?1:0),0<this.$downloadableFiles.length?(n=this.$downloadableFiles.find("input[type=file]")[0],[4,this.readUploadableFile(n)]):[3,2];case 1:(i=e.sent())&&(l=this.$downloadableFiles.find("input[type=file]").val().split("\\"),a=l[l.length-1],t.uploadDownloadableFile=i,t.uploadDownloadableTitle=this.$downloadableFiles.find("#downloadableFileTitle").val(),t.uploadDownloadableFilename=a),e.label=2;case 2:return $.post(this.$form.attr("action"),t,function(e){e.success?(window.setTimeout(function(){o.editor.destroy()},100),o.$textSaver.addClass("hidden"),o.$textHolder.attr("contenteditable","false"),o.$editCaller.removeClass("hidden"),o.$contentSettings.addClass("hidden"),null!==e.title&&($(".pageTitle").text(e.title),document.title=e.title,$("#mainmenu .page"+e.id).text(e.title),$(".breadcrumb").children().last().text(e.title)),e.uploadedFile&&o.addUploadedFileCb(e.uploadedFile),o.hideDownloadableFiles(),e.message&&alert(e.message),e.redirectTo&&(window.location.href=e.redirectTo)):alert("Something went wrong...")}),[2]}})})},e.prototype.onSubmitDeleteForm=function(e,t){t&&(t.confirmed,1)&&!0===t.confirmed||(e.preventDefault(),bootbox.confirm(__t("admin","delPageConfirm"),function(e){e&&$(".deletePageForm").trigger("submit",{confirmed:!0})}))},e}();t.ContentPageEdit=n});
//# sourceMappingURL=ContentPageEdit.js.map
