define(["require","exports","./ResponsibilitySetter"],function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ProposedProcedureOverview=void 0;var n=function(){function t(t){this.$widget=t,this.plannedInterval=null,this.csrf=this.$widget.find("input[name=_csrf]").val(),this.$widget.on("change","input[name=visible]",this.onVisibleChanged.bind(this)),this.initComments(),this.initUpdateWidget(),this.onContentUpdated(),new i.ResponsibilitySetter($(".proposedProcedureReloadHolder")),this.$widget.on("click",".contactShow",function(t){t.preventDefault(),$(t.currentTarget).next(".contactDetails").removeClass("hidden")})}return t.prototype.onContentUpdated=function(){this.$widget.find(".commentList").each(function(t,e){e.scrollTop=e.scrollHeight})},t.prototype.onVisibleChanged=function(t){var e=$(t.currentTarget),i={_csrf:this.csrf,visible:e.prop("checked")?1:0,id:e.parents(".item").first().data("id")};$.post(e.data("save-url"),i,function(t){t.success||alert(t.error)})},t.prototype.initComments=function(){var i=this;this.$widget.on("click",".writingOpener",this.openWriting.bind(this)),this.$widget.on("click",".submitComment",function(t){t.preventDefault();var e=$(t.currentTarget);i.submitComment(e.parents("td").first())}),this.$widget.on("click",".cancelWriting",function(t){t.preventDefault(),$(t.currentTarget).parents("td").first().removeClass("writing")}),this.$widget.on("keypress","textarea",function(t){if(t.originalEvent.metaKey&&13===t.originalEvent.keyCode){var e=$(t.currentTarget);i.submitComment(e.parents("td").first())}})},t.prototype.openWriting=function(t){t.preventDefault();var e=$(t.currentTarget).parents("td").first();e.addClass("writing"),e.find("textarea").focus()},t.prototype.submitComment=function(i){var t={_csrf:this.csrf,comment:i.find("textarea").val(),id:i.parents(".item").data("id")};$.post(i.data("post-url"),t,function(t){if(t.success){var e=i.find(".template").clone();e.find(".date").text(t.date_str),e.find(".name").text(t.user_str),e.find(".comment").html(t.text),e.removeClass("template"),e.insertBefore(i.find(".template")),window.setTimeout(function(){i.find(".commentList")[0].scrollTop=i.find(".commentList")[0].scrollHeight},1),i.find("textarea").val(""),i.removeClass("writing")}else alert(t.error)})},t.prototype.skipReload=function(){return 0<this.$widget.find(".respHolder.dropdown.open").length||0<this.$widget.find(".comments.writing").length},t.prototype.reload=function(e){var i=this;if(this.skipReload())return console.log("No reload, as comment writing is active"),void e();$.ajax({type:"GET",url:this.updateUrl,success:function(t){t.success?(i.$dateField.text(t.date),i.$proposalList.html(t.html),i.onContentUpdated(),e()):alert(t.error)},error:function(){e()}})},t.prototype.executeInterval=function(){var t=this;this.reload(function(){t.plannedInterval=window.setTimeout(t.executeInterval.bind(t),5e3)})},t.prototype.startInterval=function(){null===this.plannedInterval&&(this.plannedInterval=window.setTimeout(this.executeInterval.bind(this),5e3))},t.prototype.stopInterval=function(){null!==this.plannedInterval&&(window.clearTimeout(this.plannedInterval),this.plannedInterval=null)},t.prototype.initUpdateWidget=function(){var t=this;this.$updateWidget=this.$widget.find(".autoUpdateWidget"),this.$proposalList=this.$widget.find(".reloadContent"),this.$dateField=this.$widget.find(".currentDate .date"),this.updateUrl=this.$widget.data("reload-url");var e=this.$updateWidget.find("#autoUpdateToggle");e.on("change",function(){e.prop("checked")?(t.reload(function(){}),t.startInterval()):t.stopInterval()}).trigger("change")},t}();e.ProposedProcedureOverview=n});
//# sourceMappingURL=ProposedProcedureOverview.js.map
