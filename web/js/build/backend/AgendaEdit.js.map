{"version":3,"sources":["backend/AgendaEdit.ts"],"names":["AgendaEdit","$widget","_this","this","delAgendaItemStr","$agenda","$","locale","attr","addClass","nestedSortable","handle","items","toleranceElement","placeholder","tolerance","forcePlaceholderSize","helper","axis","update","trigger","on","saveNewOrder","find","each","i","el","prepareAgendaItem","prepareAgendaList","agendaItemAdd","bind","agendaDateAdd","showTimesChanges","delAgendaItem","editAgendaItem","submitSingleItemForm","prototype","buildAgendaStruct","$ol","children","$li","length","push","type","id","parseInt","data","saveUrl","structure","post","_csrf","val","JSON","stringify","ret","alert","ev","preventDefault","target","parents","first","$parentLi","position","prevAll","parentId","$form","saveData","title","hasClass","date","datetimepicker","format","prop","$newItem","replaceWith","delUrl","bootbox","confirm","__t","result","remove","$newElement","before","removeClass","$item","prepend","append","stopPropagation","preDate","moment","defaultDate","$list","full","str","$el","exports"],"mappings":"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","file":"AgendaEdit.js","sourcesContent":["/// <reference path=\"../typings/nestedSortable/index.d.ts\" />\n\ndeclare let moment: any;\n\nexport class AgendaEdit {\n    private readonly $agenda: JQuery;\n    private readonly locale: string;\n\n    private delAgendaItemStr = '<a href=\"#\" class=\"delAgendaItem\"><span class=\"glyphicon glyphicon-minus-sign\"></span></a>';\n\n    constructor(private $widget: JQuery) {\n        this.$agenda = $('.motionListWithinAgenda');\n        this.locale = $(\"html\").attr('lang');\n\n        this.$agenda.addClass('agendaListEditing');\n        this.$agenda.nestedSortable({\n            handle: '.moveHandle',\n            items: 'li.agendaItem',\n            toleranceElement: '> div',\n            placeholder: 'movePlaceholder',\n            tolerance: 'pointer',\n            forcePlaceholderSize: true,\n            helper: 'clone',\n            axis: 'y',\n            update: () => {\n                this.$agenda.trigger(\"antragsgruen:agenda-change\").trigger(\"antragsgruen:agenda-reordered\");\n            }\n        });\n        this.$agenda.on(\"antragsgruen:agenda-reordered\", () => {\n            this.saveNewOrder();\n        });\n        this.$agenda.find('.agendaItem').each((i, el) => {\n            this.prepareAgendaItem($(el));\n        });\n\n        this.prepareAgendaList(this.$agenda, true);\n\n\n        this.$agenda.on('click', '.agendaItemAdder .addEntry', this.agendaItemAdd.bind(this));\n        this.$agenda.on('click', '.agendaItemAdder .addDate', this.agendaDateAdd.bind(this));\n        this.$agenda.on('change', '.agendaItemAdder .showTimes input', this.showTimesChanges.bind(this));\n        this.$agenda.on('click', '.delAgendaItem', this.delAgendaItem.bind(this));\n        this.$agenda.on('click', '.editAgendaItem', this.editAgendaItem.bind(this));\n        this.$agenda.on('submit', '.agendaItemEditForm', this.submitSingleItemForm.bind(this));\n        this.$agenda.on('submit', '.agendaDateEditForm', this.submitSingleItemForm.bind(this));\n    }\n\n    buildAgendaStruct($ol) {\n        let items = [];\n        $ol.children('.agendaItem').each((i, el) => {\n            const $li = $(el);\n            if ($li.find('> div > .agendaDateEditForm').length > 0) {\n                items.push({\n                    'type': 'date',\n                    'id': parseInt($li.data(\"id\")),\n                    'children': this.buildAgendaStruct($li.find('> ol'))\n                });\n            } else {\n                items.push({\n                    'type': 'std',\n                    'id': parseInt($li.data(\"id\")),\n                    'children': this.buildAgendaStruct($li.find('> ol'))\n                });\n            }\n        });\n        return items;\n    }\n\n    private saveNewOrder() {\n        const saveUrl = this.$widget.data(\"save-order\") as string,\n            structure = this.buildAgendaStruct(this.$widget.find(\"> ol\"));\n\n        $.post(saveUrl, {\n            '_csrf': $('input[name=_csrf]').val(),\n            'data': JSON.stringify(structure),\n        }, ret => {\n            if (!ret['success']) {\n                alert(\"Could not save: \" + ret['message']);\n                return;\n            }\n            this.$agenda.trigger(\"antragsgruen:agenda-change\");\n        });\n    }\n\n    submitSingleItemForm(ev: Event) {\n        ev.preventDefault();\n        let $li = $(ev.target).parents('li.agendaItem').first(),\n            $parentLi = $li.parents('li').first(),\n            position = $li.prevAll().length,\n            parentId = ($parentLi.length > 0 ? $parentLi.data('id') : null),\n            $form = $(ev.target),\n            saveUrl = $li.data('save-url') as string;\n\n        const saveData = {\n            'parentId': parentId,\n            'position': position,\n            'title': $form.find('input[name=title]').val() as string,\n        };\n\n        if ($li.hasClass('agendaItemDate')) {\n            saveData['type'] = 'date';\n            const date = ($form.find(\".date\") as any).datetimepicker(\"date\");\n            if (date) {\n                saveData['date'] = date.format(\"YYYY-MM-DD\");\n            } else {\n                saveData['date'] = null;\n            }\n        } else {\n            saveData['type'] = 'agendaItem';\n            saveData['inProposedProcedures'] = $form.find('input[name=inProposedProcedures]').prop('checked');\n            saveData['motionType'] = parseInt($form.find('select[name=motionType]').val() as string);\n            saveData['time'] = $form.find('input[name=time]').val() as string;\n            saveData['code'] = $form.find('input[name=code]').val() as string;\n        }\n\n        $.post(saveUrl, {\n            '_csrf': $('input[name=_csrf]').val(),\n            'data': JSON.stringify(saveData),\n        }, ret => {\n            if (!ret['success']) {\n                alert(\"Could not save: \" + ret['message']);\n                return;\n            }\n            const $newItem = $(ret['html']);\n            $li.replaceWith($newItem);\n            this.prepareAgendaItem($newItem);\n            $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n        });\n    }\n\n    delAgendaItem(ev: Event) {\n        ev.preventDefault();\n        let $li = $(ev.target).parents('li.agendaItem').first(),\n            delUrl = $li.data('del-url') as string;\n        bootbox.confirm(__t(\"admin\", \"agendaDelEntryConfirm\"), (result) => {\n            if (result) {\n                $.post(delUrl, {\n                    '_csrf': $('input[name=_csrf]').val(),\n                }, ret => {\n                    if (!ret['success']) {\n                        alert(\"Could not delete: \" + ret['message']);\n                        return;\n                    }\n                    $li.remove();\n                    $('ol.motionListWithinAgenda').trigger(\"antragsgruen:agenda-change\");\n                });\n            }\n        });\n    }\n\n    editAgendaItem(ev: Event) {\n        ev.preventDefault();\n        let $li = $(ev.target).parents('li.agendaItem').first();\n        $li.addClass('editing');\n        $li.find('> div > .agendaItemEditForm input[name=code]').trigger(\"focus\").trigger(\"select\");\n    }\n\n    agendaItemAdd(ev: Event) {\n        ev.preventDefault();\n        let $newElement = $($('#agendaNewElementTemplate').val() as string),\n            $adder = $(ev.target).parents('.agendaItemAdder').first();\n        $adder.before($newElement);\n        this.prepareAgendaItem($newElement);\n        $newElement.find('.editAgendaItem').trigger('click');\n        $newElement.find('.agendaItemEditForm input.code').trigger(\"focus\");\n    }\n\n    agendaDateAdd(ev: Event) {\n        ev.preventDefault();\n        let $newElement = $($('#agendaNewDateTemplate').val() as string),\n            $adder = $(ev.target).parents('.agendaItemAdder').first();\n        $adder.before($newElement);\n        this.prepareAgendaItem($newElement);\n        $newElement.find('.editAgendaItem').trigger('click');\n    }\n\n    showTimesChanges() {\n        if (this.$widget.find('.agendaItemAdder .showTimes input').prop(\"checked\")) {\n            this.$agenda.addClass('showTimes').removeClass('noShowTimes');\n        } else {\n            this.$agenda.removeClass('showTimes').addClass('noShowTimes');\n        }\n    }\n\n    prepareAgendaItem($item) {\n        $item.find('> div').prepend('<span class=\"glyphicon glyphicon-resize-vertical moveHandle\"></span>');\n        $item.find('> div > h3').append('<a href=\"#\" class=\"editAgendaItem\"><span class=\"glyphicon glyphicon-pencil\"></span></a>');\n        $item.find('> div > h3').append(this.delAgendaItemStr);\n        $item.find('> div li.checkbox').on('click', (ev) => {\n            ev.stopPropagation();\n        });\n\n        $item.find('> ol.agenda').each((i, el) => {\n            this.prepareAgendaList($(el), false);\n        });\n\n        $item.find(\"> div .input-group.time\").datetimepicker({\n            locale: this.locale,\n            format: 'LT'\n        });\n\n        $item.find(\"> div .input-group.date\").each((i, el) => {\n            let preDate = null;\n            if ($(el).data(\"date\")) {\n                preDate = moment($(el).data(\"date\"), \"YYYY-MM-DD\", this.locale);\n            }\n            $(el).datetimepicker({\n                locale: this.locale,\n                format: 'dddd, Do MMMM YYYY',\n                defaultDate: preDate\n            });\n        });\n    }\n\n    prepareAgendaList($list, full: boolean) {\n        let str = '<li class=\"agendaItemAdder mjs-nestedSortable-no-nesting mjs-nestedSortable-disabled\">' +\n            '<a href=\"#\" class=\"addEntry\"><span class=\"glyphicon glyphicon-plus-sign\"></span> ' + __t('admin', 'agendaAddEntry') + '</a>';\n        if (full) {\n            str += '<a href=\"#\" class=\"addDate\"><span class=\"glyphicon glyphicon-plus-sign\"></span> ' + __t('admin', 'agendaAddDate') + '</a>' +\n                '<span class=\"spacer\"></span>' +\n            '<label class=\"showTimes\"><input type=\"checkbox\" class=\"showTimes\"> ' + __t('admin', 'agendaShowTimes') + '</label>';\n        }\n        str += '</li>';\n        const $el = $(str);\n        if (this.$agenda.hasClass('showTimes')) {\n            $el.find(\".showTimes input\").prop(\"checked\", true);\n        }\n        $list.append($el);\n    }\n}\n"]}